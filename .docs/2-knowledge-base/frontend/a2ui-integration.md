# A2UI Protocol Integration - Frontend Implementation

## Overview

The frontend A2UI implementation enables real-time rendering of declarative UI components generated by AI agents. A2UI (Agent-to-UI) messages arrive through the same SSE stream as AG-UI events and are processed to create interactive UI surfaces.

## Architecture

### Data Flow

```
Backend A2UI Agent
       ↓ (SSE Stream)
ChatContainer (Event Detection)
       ↓
useA2UIEvents Hook (Message Processing)
       ↓
A2UI Store (State Management)
       ↓
A2UIRenderer (Component Rendering)
       ↓
Native React Components (Shadcn UI)
```

### Key Components

1. **Type Definitions** (`types/a2ui.ts`)
   - TypeScript interfaces for all A2UI message types
   - Helper functions for message validation and path resolution

2. **State Management** (`stores/a2uiStore.ts`)
   - Zustand store for managing surfaces and data models
   - Adjacency list component storage
   - JSON Pointer path-based data updates

3. **Event Processing** (`hooks/useA2UIEvents.ts`)
   - Processes A2UI messages from SSE stream
   - Updates store based on message type

4. **Component Rendering** (`components/A2UI/`)
   - `A2UIRenderer.tsx`: Main renderer for surfaces
   - `components/A2UICheckbox.tsx`: Interactive checkbox with data binding

5. **Integration** (`components/ChatContainer.tsx`, `components/MessageHistory.tsx`)
   - Detects A2UI messages in event stream
   - Renders A2UI surfaces alongside chat messages

## Message Types

### 1. surfaceUpdate

Defines or updates UI components in a surface.

```typescript
{
  type: "surfaceUpdate",
  surfaceId: "surface-abc",
  components: [
    {
      id: "checkbox-1",
      component: {
        Checkbox: {
          label: { literalString: "I agree" },
          value: { path: "/form/agreed" }
        }
      }
    }
  ]
}
```

### 2. dataModelUpdate

Updates the data model for components.

```typescript
{
  type: "dataModelUpdate",
  surfaceId: "surface-abc",
  path: "/form",
  contents: [
    { key: "agreed", valueBoolean: false }
  ]
}
```

### 3. beginRendering

Signals the client to start rendering from root component.

```typescript
{
  type: "beginRendering",
  surfaceId: "surface-abc",
  rootComponentId: "checkbox-1"
}
```

### 4. deleteSurface

Removes a UI surface.

```typescript
{
  type: "deleteSurface",
  surfaceId: "surface-abc"
}
```

## Component Catalog

### Checkbox

Interactive checkbox component with data binding.

**A2UI Definition:**
```json
{
  "id": "terms-checkbox",
  "component": {
    "Checkbox": {
      "label": { "literalString": "Accept terms" },
      "value": { "path": "/form/accepted" }
    }
  }
}
```

**Features:**
- Two-way data binding via JSON Pointer paths
- Updates data model on user interaction
- Supports literal or dynamic labels
- Built with Shadcn UI `Checkbox` component

**Props:**
- `label`: Either `literalString` (static text) or `path` (from data model)
- `value.path`: JSON Pointer path to boolean value in data model

### Button

Interactive button component with action triggering.

**A2UI Definition:**
```json
{
  "id": "submit-btn",
  "component": {
    "Button": {
      "label": { "literalString": "Submit" },
      "onPress": { "action": "submit_form" }
    }
  }
}
```

**Features:**
- Triggers custom actions via `onAction` callback
- Supports multiple variants (default, destructive, outline, etc.)
- Built with Shadcn UI `Button` component

**Props:**
- `label`: Button text (literalString or path)
- `onPress.action`: Action name to trigger
- `variant`: Optional button style variant

### TextInput

Text input or textarea component with data binding.

**A2UI Definition (Single-line):**
```json
{
  "id": "name-input",
  "component": {
    "TextInput": {
      "label": { "literalString": "Full Name" },
      "placeholder": { "literalString": "Enter your name" },
      "value": { "path": "/form/name" },
      "multiline": false
    }
  }
}
```

**A2UI Definition (Multi-line textarea):**
```json
{
  "id": "comments-input",
  "component": {
    "TextInput": {
      "label": { "literalString": "Comments" },
      "placeholder": { "literalString": "Enter your comments" },
      "value": { "path": "/form/comments" },
      "multiline": true
    }
  }
}
```

**Features:**
- Two-way data binding via JSON Pointer paths
- Automatic switch between `<Input>` and `<Textarea>` based on `multiline` prop
- Updates data model on user input
- Built with Shadcn UI `Input` and `Textarea` components

**Props:**
- `label`: Optional label text above input (literalString or path)
- `placeholder`: Placeholder text when empty
- `value.path`: JSON Pointer path to string value in data model
- `multiline`: Boolean flag for textarea (default: false)

**Implementation:**
```typescript
// Component: A2UITextInput.tsx
{isMultiline ? (
  <Textarea
    id={id}
    value={value}
    onChange={handleChange}
    placeholder={placeholderText}
    rows={4}
    className="resize-y"
  />
) : (
  <Input
    id={id}
    type="text"
    value={value}
    onChange={handleChange}
    placeholder={placeholderText}
  />
)}
```

### Container Components (Row, Column, Card)

Layout components for organizing child components.

**Usage:**
```json
{
  "id": "form-container",
  "component": {
    "Card": {
      "children": ["checkbox-1", "checkbox-2"]
    }
  }
}
```

## State Management

### Surface Structure

```typescript
interface Surface {
  id: string;
  components: Map<string, A2UIComponent>; // Adjacency list
  dataModel: Record<string, any>;
  rootComponentId?: string;
  isRendering: boolean;
}
```

### Store Actions

**createOrUpdateSurface(surfaceId, components)**
- Creates new surface or adds components to existing one
- Stores components in adjacency list (Map)

**updateDataModel(surfaceId, path, contents)**
- Updates data model at JSON Pointer path
- Supports nested updates

**beginRendering(surfaceId, rootComponentId)**
- Marks surface as ready to render
- Sets root component for tree traversal

**deleteSurface(surfaceId)**
- Removes surface from store

## Event Integration

### Detection

A2UI messages are detected in the ChatContainer's event stream:

```typescript
const unsubscribeAll = on('*', (event) => {
  if (isA2UIMessage(event)) {
    processA2UIMessage(event);
  }
});
```

### Processing

The `useA2UIEvents` hook routes messages to appropriate store actions:

```typescript
switch (a2uiMessage.type) {
  case 'surfaceUpdate':
    createOrUpdateSurface(surfaceId, components);
    break;
  case 'dataModelUpdate':
    updateDataModel(surfaceId, path, contents);
    break;
  // ...
}
```

## Rendering

### Surface Rendering

Surfaces are rendered in `MessageHistory` after chat messages:

```typescript
{surfaceIds.map((surfaceId) => (
  <A2UIRenderer key={surfaceId} surfaceId={surfaceId} />
))}
```

### Component Tree Traversal

`A2UIRenderer` recursively renders components starting from root:

```typescript
const renderComponent = (componentId: string): React.ReactNode => {
  const component = surface.components.get(componentId);
  const [componentType, props] = Object.entries(component.component)[0];
  
  switch (componentType) {
    case 'Checkbox':
      return <A2UICheckbox {...props} />;
    case 'Row':
      return (
        <div className="flex flex-row">
          {props.children?.map(renderComponent)}
        </div>
      );
    // ...
  }
};
```

## Data Binding

### JSON Pointer Paths

A2UI uses JSON Pointer (RFC 6901) for referencing data:

```
/form/user/name      → dataModel.form.user.name
/settings/theme      → dataModel.settings.theme
/accepted            → dataModel.accepted
```

### Resolution

The `resolvePath` helper navigates the data model:

```typescript
function resolvePath(obj: any, path?: string): any {
  if (!path) return undefined;
  const keys = path.split('/').filter(k => k);
  let current = obj;
  for (const key of keys) {
    current = current[key];
  }
  return current;
}
```

### Updates

When user interacts with components, data model is updated:

```typescript
const handleChange = (newValue: boolean) => {
  updateDataModel(surfaceId, parentPath, [
    { key, valueBoolean: newValue }
  ]);
};
```

## Styling

### Surface Styling

Surfaces have consistent styling with chat messages:

```css
.a2ui-surface {
  @apply border rounded-lg p-4 my-2 bg-card;
}
```

### Component Styling

Components use Shadcn UI with Tailwind CSS:

```typescript
<div className="flex items-center space-x-2 py-2">
  <Checkbox id={id} checked={checked} />
  <Label htmlFor={id}>{labelText}</Label>
</div>
```

## Testing Considerations

### Unit Tests

1. **Type validation**: Test message type guards
2. **Store operations**: Test surface creation, data updates
3. **Path resolution**: Test JSON Pointer parsing

### Integration Tests

1. **Event processing**: Test A2UI message detection
2. **Component rendering**: Test checkbox rendering from surface
3. **Data binding**: Test user interaction updates data model

### E2E Tests

1. **Full flow**: Backend sends A2UI → Frontend renders UI
2. **User interaction**: Click checkbox → Backend receives update
3. **Multiple surfaces**: Multiple agents create separate UIs

## Future Enhancements

### Additional Components

- **Input**: Text input with validation
- **Button**: Clickable button with actions
- **Dropdown**: Select from options
- **Table**: Tabular data display
- **Chart**: Data visualization

### Advanced Features

- **User Actions**: Send user interactions back to backend
- **Form Submission**: Collect and submit form data
- **Validation**: Client-side validation with error messages
- **Animation**: Smooth transitions for UI updates
- **Custom Themes**: Apply theme styles to A2UI components

### Performance Optimizations

- **Lazy rendering**: Only render visible surfaces
- **Virtual scrolling**: Handle large component trees
- **Memoization**: Cache component renders
- **Batch updates**: Group data model updates

## Troubleshooting

### Surface Not Rendering

**Problem**: Surface created but not visible

**Solutions**:
1. Check `beginRendering` was received
2. Verify `rootComponentId` exists in components
3. Check `surface.isRendering` is `true`

### Data Not Updating

**Problem**: User interactions don't update UI

**Solutions**:
1. Verify path in `value.path` is correct
2. Check data model has initial value
3. Ensure `updateDataModel` is called

### Component Type Unknown

**Problem**: "Unknown component type" warning

**Solutions**:
1. Add component type to renderer switch statement
2. Check component name matches exactly (case-sensitive)
3. Verify component structure in A2UI message

## Best Practices

1. **Always send beginRendering**: Don't render until all components and data are ready
2. **Use meaningful surface IDs**: Helps debugging and surface management
3. **Initialize data model**: Set default values before rendering
4. **Handle missing data gracefully**: Use fallback values
5. **Log A2UI events**: Enable debugging with console logs
6. **Type everything**: Leverage TypeScript for type safety
7. **Follow Shadcn UI patterns**: Keep component styling consistent

## References

- [A2UI Specification](https://a2ui.org/specification/v0.8-a2ui/)
- [JSON Pointer RFC 6901](https://tools.ietf.org/html/rfc6901)
- [Shadcn UI Documentation](https://ui.shadcn.com/)
- [Zustand Documentation](https://zustand-demo.pmnd.rs/)
- [Implementation Plan](../../1-implementation-plans/017-support-a2ui-protocol-plan.md)
